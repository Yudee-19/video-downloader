Excellent ‚Äî since your app uses **FastAPI + yt-dlp**, here‚Äôs exactly how you can integrate those two fixes (cookies and randomized headers) so YouTube no longer triggers the *‚ÄúSign in to confirm you‚Äôre not a bot‚Äù* error.

---

## üß© 1. Using `cookies.txt` in `yt-dlp`

Your backend (in `backend/main.py`) runs `yt-dlp` inside a function like:

```python
with yt_dlp.YoutubeDL(ydl_opts) as ydl:
    ydl.download([url])
```

To make yt-dlp use cookies, just add this option:

```python
"cookiefile": "/app/cookies.txt",
```

‚úÖ This is equivalent to:

```
yt-dlp --cookies /app/cookies.txt <URL>
```

---

## üß© 2. Adding Randomized Headers (User-Agent, Accept-Language, etc.)

You can randomize the headers each time a video is downloaded.
Use Python‚Äôs `random.choice()` with a small list of common browser `User-Agent`s.

Here‚Äôs how to modify your download function:

```python
import yt_dlp, os, uuid, random

def run_ytdlp(url, filepath):
    user_agents = [
        "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",
        "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.0 Safari/605.1.15",
        "Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:118.0) Gecko/20100101 Firefox/118.0",
    ]

    ydl_opts = {
        "outtmpl": filepath,
        "format": "bestvideo+bestaudio/best",
        "cookiefile": "/app/cookies.txt",  # ‚úÖ Use cookies
        "http_headers": {                  # ‚úÖ Randomized headers
            "User-Agent": random.choice(user_agents),
            "Accept-Language": "en-US,en;q=0.9",
        },
        "retries": 5,
        "fragment_retries": 5,
    }

    with yt_dlp.YoutubeDL(ydl_opts) as ydl:
        ydl.download([url])
```

---

## üß± Example Integration in FastAPI

```python
from fastapi import FastAPI, BackgroundTasks
from fastapi.responses import FileResponse
import yt_dlp, os, uuid, random

app = FastAPI()
TEMP_DIR = "tmp_videos"
os.makedirs(TEMP_DIR, exist_ok=True)

@app.post("/download")
async def download_video(payload: dict, background_tasks: BackgroundTasks):
    url = payload["url"]
    video_id = str(uuid.uuid4())
    filepath = f"{TEMP_DIR}/{video_id}.mp4"

    def run_ytdlp():
        user_agents = [
            "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",
            "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.0 Safari/605.1.15",
            "Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:118.0) Gecko/20100101 Firefox/118.0",
        ]

        ydl_opts = {
            "outtmpl": filepath,
            "format": "bestvideo+bestaudio/best",
            "cookiefile": "/app/cookies.txt",
            "http_headers": {
                "User-Agent": random.choice(user_agents),
                "Accept-Language": "en-US,en;q=0.9",
            },
            "retries": 5,
        }

        with yt_dlp.YoutubeDL(ydl_opts) as ydl:
            ydl.download([url])

    background_tasks.add_task(run_ytdlp)
    return {"file_id": video_id}
```

---

## üê≥ 3. Docker Considerations

Your `cookies.txt` file must exist **inside the container** at `/app/cookies.txt`.

If your Dockerfile looks like this:

```dockerfile
FROM python:3.12-slim

WORKDIR /app
COPY backend/ /app/
COPY cookies.txt /app/cookies.txt

RUN pip install -r requirements.txt
CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]
```

‚úÖ This ensures the cookies file is accessible at `/app/cookies.txt`.

---

## üß† Summary of Fixes

| Problem                                       | Solution                                                                         |
| --------------------------------------------- | -------------------------------------------------------------------------------- |
| YouTube ‚ÄúSign in to confirm you‚Äôre not a bot‚Äù | Use cookies.txt with valid session cookies                                       |
| YouTube bot detection                         | Randomize User-Agent and headers each download                                   |
| Sometimes throttled speed                     | Add `--http-chunk-size 10M` or retries in `ydl_opts`                             |
| Still failing after deploy                    | Ensure cookies file copied into container and readable (`chmod 644 cookies.txt`) |

---

Would you like me to show you **how to patch your existing `main.py` automatically** (line-by-line update for your repo structure)? That way you can copy-paste the new version directly.
